summary: Smoke test for fastapi-framework

execute: |
  rockcraft init --profile fastapi-framework --name fastapi-hello-world
  ROCKCRAFT_ENABLE_EXPERIMENTAL_EXTENSIONS=true rockcraft pack
  rockcraft.skopeo --insecure-policy copy --dest-tls-verify=false \
   oci-archive:fastapi-hello-world_0.1_amd64.rock \
   docker://localhost:32000/fastapi-hello-world:0.1

  mkdir charm
  cd charm
  charmcraft init --profile fastapi-framework --name fastapi-hello-world
  CHARMCRAFT_ENABLE_EXPERIMENTAL_EXTENSIONS=true charmcraft fetch-libs
  CHARMCRAFT_ENABLE_EXPERIMENTAL_EXTENSIONS=true charmcraft pack

  juju deploy ./fastapi-hello-world_amd64.charm fastapi-hello-world \
   --resource app-image=localhost:32000/fastapi-hello-world:0.1

  juju wait-for application fastapi-hello-world

  UNIT_IP=$(juju status --format json | jq -r '.applications."fastapi-hello-world".address') && echo $UNIT_IP
  retry -n 5 --wait 2 curl --fail "${UNIT_IP}:8080"
  [[ \"$(curl --fail "${UNIT_IP}:8080")\" =~ "Hello, world" ]]
